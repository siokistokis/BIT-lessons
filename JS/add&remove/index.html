<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        /* General styling */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }

        #invoice-list-container {
            margin-bottom: 20px;
        }

        #create-invoice-container {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2 {
            text-align: center;
        }

        .button-group {
            text-align: center;
            margin-top: 20px;
        }

        .button-group button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 5px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }

        .button-group button:hover {
            background-color: #45a049;
        }

        /* Invoice Form Styling */
        .invoice-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .invoice-details div {
            width: 48%;
        }

        .invoice-details label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        .invoice-details input[type="text"],
        .invoice-details input[type="date"],
        .invoice-details input[type="number"] {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        /* Align numbers to the right for all numeric fields */
        .invoice-details input[type="number"] {
            text-align: right;
        }

        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        table th,
        table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }

        table th {
            background-color: #f2f2f2;
        }

        /* Align numbers on the right */
        table td:nth-child(2),
        table td:nth-child(3),
        table td:nth-child(4),
        table td:nth-child(5) {
            text-align: right;
        }

        /* Optional: Style for inputs inside table cells */
        table input[type="number"] {
            width: 100%;
            text-align: right;
            padding: 5px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>

<body>

    <!-- Invoice List Container -->
    <div id="invoice-list-container">
        <h1>VAT Invoice List</h1>
        <button onclick="showCreateInvoice()">Create Invoice</button>
        <div id="invoice-list"></div>
    </div>

    <!-- Create Invoice Container -->
    <div id="create-invoice-container">
        <h2>NEW VAT INVOICE</h2>

        <!-- Customer and Company Details -->
        <div class="invoice-details">
            <div>
                <label for="customer-name">Customer Name</label>
                <input type="text" id="customer-name" placeholder="Enter Customer Name" />

                <label for="company-name">Company Name</label>
                <input type="text" id="company-name" placeholder="Enter Company Name" />
            </div>

            <div>
                <label for="invoice-number">Invoice Number</label>
                <input type="text" id="invoice-number" placeholder="Invoice Number" />

                <label for="invoice-date">Invoice Date</label>
                <input type="date" id="invoice-date" />
            </div>
        </div>

        <!-- Items Table -->
        <div id="new-invoice-data"></div>

        <div class="button-group">
            <button onclick="saveInvoice()">Save</button>
            <button onclick="updateInvoice()">Update</button>
            <button onclick="cancelInvoice()">Cancel</button>
        </div>
    </div>

    <script>
        let currentInvoice = null;

        // Show the form to create or edit an invoice
        async function showCreateInvoice() {
            document.getElementById('invoice-list-container').style.display = 'none';
            document.getElementById('create-invoice-container').style.display = 'block';

            const invoice = await fetchNewInvoice();
            if (!invoice) return;

            currentInvoice = invoice;
            displayInvoiceForm(invoice, 'new-invoice-data', true);
        }

        // Fetch invoice data (could be new or an existing one)
        async function fetchNewInvoice() {
            try {
                const response = await fetch('https://in3.dev/inv/');
                if (!response.ok) throw new Error('Data could not be retrieved');
                const data = await response.json();
                return data;
            } catch (error) {
                showMessage('Error while retrieving data from API', 'error');
                console.error(error);
                return null;
            }
        }

        // Display the invoice form
        function displayInvoiceForm(invoice, containerId, isEditable = false) {
            const container = document.getElementById(containerId);
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Amount</th>
                            <th>Price</th>
                            <th>Discount</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            invoice.items.forEach((item, index) => {
                let quantity = item.quantity || 0;
                let price = item.price || 0;
                let discount = item.discount || 0;
                let total = (quantity * price) - discount;

                // Ensure valid numbers
                if (isNaN(total)) total = 0;

                html += `
                    <tr>
                        <td><input type="text" value="${item.description}" ${isEditable ? '' : 'disabled'} /></td>
                        <td><input type="number" value="${quantity}" ${isEditable ? '' : 'disabled'} onchange="recalculateTotal(${index})" /></td>
                        <td><input type="number" value="${price}" ${isEditable ? '' : 'disabled'} onchange="recalculateTotal(${index})" /></td>
                        <td><input type="number" value="${discount}" ${isEditable ? '' : 'disabled'} onchange="recalculateTotal(${index})" /></td>
                        <td><input type="number" value="${total.toFixed(2)}" disabled /></td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;

            // Recalculate all totals
            recalculateAllTotals();
        }

        // Recalculate total for a specific row
        function recalculateTotal(index) {
            const row = document.querySelector(`#new-invoice-data table tbody tr:nth-child(${index + 1})`);
            const quantity = parseFloat(row.querySelector('td:nth-child(2) input').value) || 0;
            const price = parseFloat(row.querySelector('td:nth-child(3) input').value) || 0;
            const discount = parseFloat(row.querySelector('td:nth-child(4) input').value) || 0;

            const total = (quantity * price) - discount;
            row.querySelector('td:nth-child(5) input').value = total.toFixed(2);

            // Recalculate grand total
            recalculateAllTotals();
        }

        // Recalculate all totals in the invoice
        function recalculateAllTotals() {
            const rows = document.querySelectorAll('#new-invoice-data table tbody tr');
            let grandTotal = 0;

            rows.forEach(row => {
                const total = parseFloat(row.querySelector('td:nth-child(5) input').value) || 0;
                grandTotal += total;
            });

            console.log('Grand Total:', grandTotal);
        }

        // Save the invoice
        async function saveInvoice() {
            const invoiceData = gatherInvoiceData();
            if (!invoiceData) {
                showMessage("Please fill in all fields", "error");
                return;
            }

            try {
                const invoiceNumber = document.getElementById('invoice-number').value;
                const invoiceDate = document.getElementById('invoice-date').value;

                let invoicesRaw = localStorage.getItem('invoices');
                let invoices = invoicesRaw ? JSON.parse(invoicesRaw) : [];

                const invoice = {
                    invoiceNumber,
                    invoiceDate,
                    customerName: document.getElementById('customer-name').value,
                    companyName: document.getElementById('company-name').value,
                    items: invoiceData.items
                };

                invoices.push(JSON.stringify(invoice));
                localStorage.setItem('invoices', JSON.stringify(invoices));

                showMessage("Invoice saved successfully", "success");
                returnToInvoiceList();
            } catch (error) {
                showMessage("Failed to save invoice", "error");
                console.error(error);
            }
        }

        // Gather data from the form
        function gatherInvoiceData() {
            const invoiceNumber = document.getElementById('invoice-number').value;
            const invoiceDate = document.getElementById('invoice-date').value;
            const customerName = document.getElementById('customer-name').value;
            const companyName = document.getElementById('company-name').value;

            if (!invoiceNumber || !invoiceDate || !customerName || !companyName) {
                return null;
            }

            const items = [];
            const rows = document.querySelectorAll('#new-invoice-data table tbody tr');
            rows.forEach(row => {
                const quantity = parseFloat(row.querySelector('td:nth-child(2) input').value) || 0;
                const price = parseFloat(row.querySelector('td:nth-child(3) input').value) || 0;
                const discount = parseFloat(row.querySelector('td:nth-child(4) input').value) || 0;

                items.push({
                    description: row.querySelector('td:nth-child(1) input').value,
                    quantity,
                    price,
                    discount
                });
            });

            return {
                number: invoiceNumber,
                date: invoiceDate,
                customerName,
                companyName,
                items
            };
        }

        // Return to the invoice list view
        function returnToInvoiceList() {
            document.getElementById('create-invoice-container').style.display = 'none';
            document.getElementById('invoice-list-container').style.display = 'block';
        }

        // Show messages
        function showMessage(message, type) {
            alert(`${type.toUpperCase()}: ${message}`);
        }
    </script>

</body>

</html>
